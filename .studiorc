hab pkg install chef/ci-studio-common >/dev/null
source "$(hab pkg path chef/ci-studio-common)/bin/studio-common"

# This removes the visual mode when select text with the mouse in vim. 
echo "set mouse-=a" >> ~/.vimrc

export MYSQL_PORT=3306
export MMSN_PORT=8080
export PHP_PORT=9000

function start() {
  install_if_missing core/busybox-static netstat;
  netstat -an | grep $MMSN_PORT | grep LISTEN >/dev/null 2>/dev/null
  if [ $? == 0 ]; then
    echo "mmsn is already running";
    return;
  fi

  start_mysql

  start_php

  build

  start_sup

  mkdir -p /hab/user/mmsn/config/
  printf "[http.listen]\n" > /hab/user/mmsn/config/user.toml
  printf "port = $MMSN_PORT\n" >> /hab/user/mmsn/config/user.toml
  printf "bind = '0.0.0.0'\n" >> /hab/user/mmsn/config/user.toml
  printf "local_only=true\n" >> /hab/user/mmsn/config/user.toml

  printf "[email]\n" >> /hab/user/mmsn/config/user.toml
  printf "should_send = true\n" >> /hab/user/mmsn/config/user.toml
  printf "from_address='sjcmmsn@gmail.com'\n" >> /hab/user/mmsn/config/user.toml
  printf "from_password='29L8PG67qdcVAdA8'\n" >> /hab/user/mmsn/config/user.toml
  printf "to_address='lancewf@gmail.com'\n" >> /hab/user/mmsn/config/user.toml
  printf "bcc_address='lancewf@gmail.com'\n" >> /hab/user/mmsn/config/user.toml

  hab start $HAB_ORIGIN/mmsn --bind database:mysql.default --bind php:php.default

  wait_or_fail_for_port_to_listen $MMSN_PORT
}

function start_php() {
  install_if_missing core/busybox-static netstat;
  netstat -an | grep $PHP_PORT | grep LISTEN >/dev/null 2>/dev/null
  if [ $? == 0 ]; then
    echo "php is already running";
    return;
  fi

  start_sup

  hab start lancewf/php

  mkdir -p /hab/user/php/config/
  printf "port = $PHP_PORT\n" > /hab/user/php/config/user.toml
  printf "listen ='127.0.0.1'\n" >> /hab/user/php/config/user.toml
  printf "local_only=true\n" >> /hab/user/php/config/user.toml

  wait_or_fail_for_port_to_listen $PHP_PORT
}

function start_mysql() {
  install_if_missing core/busybox-static netstat;
  netstat -an | grep $MYSQL_PORT | grep LISTEN >/dev/null 2>/dev/null
  if [ $? == 0 ]; then
    echo "mysql is already running";
    return;
  fi

  start_sup

  mkdir -p /hab/user/mysql/config/
  printf "app_username='lancewf'\n" > /hab/user/mysql/config/user.toml
  printf "app_password='lancewf'\n" >> /hab/user/mysql/config/user.toml
  printf "bind='127.0.0.1'\n" >> /hab/user/mysql/config/user.toml
  printf "local_only=true\n" >> /hab/user/mysql/config/user.toml

  hab start lancewf/mysql

  wait_or_fail_for_port_to_listen $MYSQL_PORT
}

function start_sup() {
  hab sup status 2>/dev/null 1>&2
  [[ $? == 0 ]] && return
  mkdir -p /hab/sup/default
  echo "=> Launching the Habitat Supervisor in the background..."
  hab sup run $* > /hab/sup/default/sup.log &
  while : ; do
    hab sup status >/dev/null
    [[ $? -eq 0 ]] && break || sleep 1
  done
}

function status() {
 hab sup status;
}

# Saves the in memory bash history to a file
function save_history() {
  history -a /src/.bash_history
}

# if .studiorc is being sourced from an already running studio, don't reset bash
# history -- this is achieved by saving the current history before it is re-read
save_history

# Load the bash history from a file
history -r /src/.bash_history

function cleanup() {
    save_history
}

# When exiting the studio save the bash history to a file
trap cleanup EXIT
